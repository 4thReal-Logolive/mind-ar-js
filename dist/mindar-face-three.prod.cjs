"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const h=require("three"),D=require("./controller.9e272f85.cjs"),_=require("./ui.d6b77cda.cjs"),C=new h.Vector3,W=new h.Quaternion,E=new h.Vector3;class R extends h.Object3D{constructor(n=document.createElement("div")){super(),this.element=n,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.addEventListener("removed",function(){this.traverse(function(s){s.element instanceof Element&&s.element.parentNode!==null&&s.element.parentNode.removeChild(s.element)})})}copy(n,s){return super.copy(n,s),this.element=n.element.cloneNode(!0),this}}R.prototype.isCSS3DObject=!0;class O extends R{constructor(n){super(n),this.rotation2D=0}copy(n,s){return super.copy(n,s),this.rotation2D=n.rotation2D,this}}O.prototype.isCSS3DSprite=!0;const y=new h.Matrix4,U=new h.Matrix4;class I{constructor(n={}){const s=this;let r,c,o,d;const a={camera:{fov:0,style:""},objects:new WeakMap},l=n.element!==void 0?n.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l;const m=document.createElement("div");m.style.transformStyle="preserve-3d",m.style.pointerEvents="none",l.appendChild(m),this.getSize=function(){return{width:r,height:c}},this.render=function(i,e){const f=e.projectionMatrix.elements[5]*d;a.camera.fov!==f&&(l.style.perspective=e.isPerspectiveCamera?f+"px":"",a.camera.fov=f),i.autoUpdate===!0&&i.updateMatrixWorld(),e.parent===null&&e.updateMatrixWorld();let S,v;e.isOrthographicCamera&&(S=-(e.right+e.left)/2,v=(e.top+e.bottom)/2);const g=(e.isOrthographicCamera?"scale("+f+")translate("+t(S)+"px,"+t(v)+"px)"+p(e.matrixWorldInverse):"translateZ("+f+"px)"+p(e.matrixWorldInverse))+"translate("+o+"px,"+d+"px)";a.camera.style!==g&&(m.style.transform=g,a.camera.style=g),u(i,i,e)},this.setSize=function(i,e){r=i,c=e,o=r/2,d=c/2,l.style.width=i+"px",l.style.height=e+"px",m.style.width=i+"px",m.style.height=e+"px"};function t(i){return Math.abs(i)<1e-10?0:i}function p(i){const e=i.elements;return"matrix3d("+t(e[0])+","+t(-e[1])+","+t(e[2])+","+t(e[3])+","+t(e[4])+","+t(-e[5])+","+t(e[6])+","+t(e[7])+","+t(e[8])+","+t(-e[9])+","+t(e[10])+","+t(e[11])+","+t(e[12])+","+t(-e[13])+","+t(e[14])+","+t(e[15])+")"}function M(i){const e=i.elements;return"translate(-50%,-50%)"+("matrix3d("+t(e[0])+","+t(e[1])+","+t(e[2])+","+t(e[3])+","+t(-e[4])+","+t(-e[5])+","+t(-e[6])+","+t(-e[7])+","+t(e[8])+","+t(e[9])+","+t(e[10])+","+t(e[11])+","+t(e[12])+","+t(e[13])+","+t(e[14])+","+t(e[15])+")")}function u(i,e,f,S){if(i.isCSS3DObject){i.onBeforeRender(s,e,f);let v;i.isCSS3DSprite?(y.copy(f.matrixWorldInverse),y.transpose(),i.rotation2D!==0&&y.multiply(U.makeRotationZ(i.rotation2D)),i.matrixWorld.decompose(C,W,E),y.setPosition(C),y.scale(E),y.elements[3]=0,y.elements[7]=0,y.elements[11]=0,y.elements[15]=1,v=M(y)):v=M(i.matrixWorld);const x=i.element,g=a.objects.get(i);if(g===void 0||g.style!==v){x.style.transform=v;const b={style:v};a.objects.set(i,b)}x.style.display=i.visible?"":"none",x.parentNode!==m&&m.appendChild(x),i.onAfterRender(s,e,f)}for(let v=0,x=i.children.length;v<x;v++)u(i.children[v],e,f)}}}class A{constructor({container:n,uiLoading:s="yes",uiScanning:r="yes",uiError:c="yes",filterMinCF:o=null,filterBeta:d=null}){this.container=n,this.ui=new _.UI({uiLoading:s,uiScanning:r,uiError:c}),this.controller=new D.Controller({filterMinCF:o,filterBeta:d}),this.scene=new h.Scene,this.cssScene=new h.Scene,this.renderer=new h.WebGLRenderer({antialias:!0,alpha:!0}),this.cssRenderer=new I({antialias:!0}),this.renderer.outputEncoding=h.sRGBEncoding,this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new h.PerspectiveCamera,this.anchors=[],this.faceMeshes=[],this.container.appendChild(this.renderer.domElement),this.container.appendChild(this.cssRenderer.domElement),this.shouldFaceUser=!0,window.addEventListener("resize",this._resize.bind(this))}async start(){this.ui.showLoading(),await this._startVideo(),await this._startAR(),this.ui.hideLoading()}stop(){this.video.srcObject.getTracks().forEach(function(s){s.stop()}),this.video.remove(),this.controller.stopProcessVideo()}switchCamera(){this.shouldFaceUser=!this.shouldFaceUser,this.stop(),this.start()}addFaceMesh(){const n=this.controller.createThreeFaceGeometry(THREE),s=new h.Mesh(n,new h.MeshStandardMaterial({color:16777215}));return s.visible=!1,s.matrixAutoUpdate=!1,this.faceMeshes.push(s),s}addAnchor(n){const s=new h.Group;s.matrixAutoUpdate=!1;const r={group:s,landmarkIndex:n,css:!1};return this.anchors.push(r),this.scene.add(s),r}addCSSAnchor(n){const s=new h.Group;s.matrixAutoUpdate=!1;const r={group:s,landmarkIndex:n,css:!0};return this.anchors.push(r),this.cssScene.add(s),r}_startVideo(){return new Promise((n,s)=>{if(this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="-2",this.container.appendChild(this.video),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this.ui.showCompatibility(),s();return}navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:this.shouldFaceUser?"face":"environment"}}).then(r=>{this.video.addEventListener("loadedmetadata",()=>{this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight),n()}),this.video.srcObject=r}).catch(r=>{console.log("getUserMedia error",r),s()})})}_startAR(){return new Promise(async(n,s)=>{const r=this.video;this.container,this.controller.onUpdate=({hasFace:l,estimateResult:m})=>{for(let t=0;t<this.anchors.length;t++)this.anchors[t].css?this.anchors[t].group.children.forEach(p=>{p.element.style.visibility=l?"visible":"hidden"}):this.anchors[t].group.visible=l;for(let t=0;t<this.faceMeshes.length;t++)this.faceMeshes[t].visible=l;if(l){const{metricLandmarks:t,faceMatrix:p,faceScale:M}=m;for(let u=0;u<this.anchors.length;u++){const i=this.anchors[u].landmarkIndex,e=this.controller.getLandmarkMatrix(i);if(this.anchors[u].css){const S=[.001*e[0],.001*e[1],e[2],e[3],.001*e[4],.001*e[5],e[6],e[7],.001*e[8],.001*e[9],e[10],e[11],.001*e[12],.001*e[13],e[14],e[15]];this.anchors[u].group.matrix.set(...S)}else this.anchors[u].group.matrix.set(...e)}for(let u=0;u<this.faceMeshes.length;u++)this.faceMeshes[u].matrix.set(...p)}},this._resize(),await this.controller.setup(r);const{fov:c,aspect:o,near:d,far:a}=this.controller.getCameraParams();this.camera.fov=c,this.camera.aspect=o,this.camera.near=d,this.camera.far=a,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.video.videoWidth,this.video.videoHeight),this.cssRenderer.setSize(this.video.videoWidth,this.video.videoHeight),await this.controller.dummyRun(r),this._resize(),this.controller.processVideo(r),n()})}_resize(){const{renderer:n,cssRenderer:s,camera:r,container:c,video:o}=this;if(!o)return;let d,a;const l=o.videoWidth/o.videoHeight,m=c.clientWidth/c.clientHeight;l>m?(a=c.clientHeight,d=a*l):(d=c.clientWidth,a=d/l),o.style.top=-(a-c.clientHeight)/2+"px",o.style.left=-(d-c.clientWidth)/2+"px",o.style.width=d+"px",o.style.height=a+"px";const t=n.domElement,p=s.domElement;t.style.position="absolute",t.style.top=o.style.top,t.style.left=o.style.left,t.style.width=o.style.width,t.style.height=o.style.height,p.style.position="absolute",p.style.top=o.style.top,p.style.left=o.style.left,p.style.transformOrigin="top left",p.style.transform="scale("+d/parseFloat(p.style.width)+","+a/parseFloat(p.style.height)+")"}}window.MINDAR||(window.MINDAR={});window.MINDAR.FACE||(window.MINDAR.FACE={});window.MINDAR.FACE.MindARThree=A;exports.MindARThree=A;
