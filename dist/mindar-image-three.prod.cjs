"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const a=require("three"),v=require("./controller.2122757b.cjs"),y=require("./CSS3DRenderer.064272a1.cjs"),M=require("./ui.d6b77cda.cjs"),g=new a.Matrix4;g.compose(new a.Vector3,new a.Quaternion,new a.Vector3(.001,.001,.001));class m{constructor({container:l,imageTargetSrc:i,maxTrack:s,uiLoading:t="yes",uiScanning:r="yes",uiError:h="yes",filterMinCF:n=null,filterBeta:e=null,warmupTolerance:o=null,missTolerance:c=null}){this.container=l,this.imageTargetSrc=i,this.maxTrack=s,this.filterMinCF=n,this.filterBeta=e,this.warmupTolerance=o,this.missTolerance=c,this.ui=new M.UI({uiLoading:t,uiScanning:r,uiError:h}),this.scene=new a.Scene,this.cssScene=new a.Scene,this.renderer=new a.WebGLRenderer({antialias:!0,alpha:!0}),this.cssRenderer=new y.CSS3DRenderer({antialias:!0}),this.renderer.outputEncoding=a.sRGBEncoding,this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new a.PerspectiveCamera,this.anchors=[],this.renderer.domElement.style.position="absolute",this.cssRenderer.domElement.style.position="absolute",this.container.appendChild(this.renderer.domElement),this.container.appendChild(this.cssRenderer.domElement),window.addEventListener("resize",this.resize.bind(this))}async start(){this.ui.showLoading(),await this._startVideo(),await this._startAR()}stop(){this.controller.stopProcessVideo(),this.video.srcObject.getTracks().forEach(function(i){i.stop()}),this.video.remove()}addAnchor(l){const i=new a.Group;i.visible=!1,i.matrixAutoUpdate=!1;const s={group:i,targetIndex:l,onTargetFound:null,onTargetLost:null,css:!1,visible:!1};return this.anchors.push(s),this.scene.add(i),s}addCSSAnchor(l){const i=new a.Group;i.visible=!1,i.matrixAutoUpdate=!1;const s={group:i,targetIndex:l,onTargetFound:null,onTargetLost:null,css:!0,visible:!1};return this.anchors.push(s),this.cssScene.add(i),s}_startVideo(){return new Promise((l,i)=>{if(this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="-2",this.container.appendChild(this.video),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this.ui.showCompatibility(),i();return}navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(s=>{this.video.addEventListener("loadedmetadata",()=>{this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight),l()}),this.video.srcObject=s}).catch(s=>{console.log("getUserMedia error",s),i()})})}_startAR(){return new Promise(async(l,i)=>{const s=this.video;this.container,this.controller=new v.Controller({inputWidth:s.videoWidth,inputHeight:s.videoHeight,filterMinCF:this.filterMinCF,filterBeta:this.filterBeta,warmupTolerance:this.warmupTolerance,missTolerance:this.missTolerance,maxTrack:this.maxTrack,onUpdate:r=>{if(r.type==="updateMatrix"){const{targetIndex:h,worldMatrix:n}=r;for(let e=0;e<this.anchors.length;e++)if(this.anchors[e].targetIndex===h){if(this.anchors[e].css?this.anchors[e].group.children.forEach(o=>{o.element.style.visibility=n===null?"hidden":"visible"}):this.anchors[e].group.visible=n!==null,n!==null){let o=new a.Matrix4;o.elements=[...n],o.multiply(this.postMatrixs[h]),this.anchors[e].css&&o.multiply(g),this.anchors[e].group.matrix=o}this.anchors[e].visible&&n===null&&(this.anchors[e].visible=!1,this.anchors[e].onTargetLost&&this.anchors[e].onTargetLost()),!this.anchors[e].visible&&n!==null&&(this.anchors[e].visible=!0,this.anchors[e].onTargetFound&&this.anchors[e].onTargetFound()),n!==null&&this.ui.hideScanning()}}}}),this.resize();const{dimensions:t}=await this.controller.addImageTargets(this.imageTargetSrc);this.postMatrixs=[];for(let r=0;r<t.length;r++){const h=new a.Vector3,n=new a.Quaternion,e=new a.Vector3,[o,c]=t[r];h.x=o/2,h.y=o/2+(c-o)/2,e.x=o,e.y=o,e.z=o;const p=new a.Matrix4;p.compose(h,n,e),this.postMatrixs.push(p)}await this.controller.dummyRun(this.video),this.ui.hideLoading(),this.ui.showScanning(),this.controller.processVideo(this.video),l()})}resize(){const{renderer:l,cssRenderer:i,camera:s,container:t,video:r}=this;if(!r)return;let h,n;const e=r.videoWidth/r.videoHeight,o=t.clientWidth/t.clientHeight;e>o?(n=t.clientHeight,h=n*e):(h=t.clientWidth,n=h/e);const c=this.controller.getProjectionMatrix(),p=2*Math.atan(1/c[5]/n*t.clientHeight)*180/Math.PI,w=c[14]/(c[10]-1),f=c[14]/(c[10]+1);c[5]/c[0],s.fov=p,s.near=w,s.far=f,s.aspect=t.clientWidth/t.clientHeight,s.updateProjectionMatrix(),r.style.top=-(n-t.clientHeight)/2+"px",r.style.left=-(h-t.clientWidth)/2+"px",r.style.width=h+"px",r.style.height=n+"px";const d=l.domElement,u=i.domElement;d.style.position="absolute",d.style.left=0,d.style.top=0,d.style.width=t.clientWidth+"px",d.style.height=t.clientHeight+"px",u.style.position="absolute",u.style.left=0,u.style.top=0,u.style.width=t.clientWidth+"px",u.style.height=t.clientHeight+"px",l.setSize(t.clientWidth,t.clientHeight),i.setSize(t.clientWidth,t.clientHeight)}}window.MINDAR||(window.MINDAR={});window.MINDAR.IMAGE||(window.MINDAR.IMAGE={});window.MINDAR.IMAGE.MindARThree=m;window.MINDAR.IMAGE.tf=v.tf;exports.MindARThree=m;
