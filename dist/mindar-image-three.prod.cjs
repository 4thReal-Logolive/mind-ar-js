"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const c=require("three"),E=require("./controller.2122757b.cjs"),W=require("./ui.d6b77cda.cjs"),b=new c.Vector3,I=new c.Quaternion,C=new c.Vector3;class A extends c.Object3D{constructor(o=document.createElement("div")){super(),this.element=o,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.addEventListener("removed",function(){this.traverse(function(n){n.element instanceof Element&&n.element.parentNode!==null&&n.element.parentNode.removeChild(n.element)})})}copy(o,n){return super.copy(o,n),this.element=o.element.cloneNode(!0),this}}A.prototype.isCSS3DObject=!0;class H extends A{constructor(o){super(o),this.rotation2D=0}copy(o,n){return super.copy(o,n),this.rotation2D=o.rotation2D,this}}H.prototype.isCSS3DSprite=!0;const f=new c.Matrix4,_=new c.Matrix4;class O{constructor(o={}){const n=this;let h,r,d,u;const l={camera:{fov:0,style:""},objects:new WeakMap},s=o.element!==void 0?o.element:document.createElement("div");s.style.overflow="hidden",this.domElement=s;const a=document.createElement("div");a.style.transformStyle="preserve-3d",a.style.pointerEvents="none",s.appendChild(a),this.getSize=function(){return{width:h,height:r}},this.render=function(i,e){const m=e.projectionMatrix.elements[5]*u;l.camera.fov!==m&&(s.style.perspective=e.isPerspectiveCamera?m+"px":"",l.camera.fov=m),i.autoUpdate===!0&&i.updateMatrixWorld(),e.parent===null&&e.updateMatrixWorld();let S,p;e.isOrthographicCamera&&(S=-(e.right+e.left)/2,p=(e.top+e.bottom)/2);const x=(e.isOrthographicCamera?"scale("+m+")translate("+t(S)+"px,"+t(p)+"px)"+v(e.matrixWorldInverse):"translateZ("+m+"px)"+v(e.matrixWorldInverse))+"translate("+d+"px,"+u+"px)";l.camera.style!==x&&(a.style.transform=x,l.camera.style=x),w(i,i,e)},this.setSize=function(i,e){h=i,r=e,d=h/2,u=r/2,s.style.width=i+"px",s.style.height=e+"px",a.style.width=i+"px",a.style.height=e+"px"};function t(i){return Math.abs(i)<1e-10?0:i}function v(i){const e=i.elements;return"matrix3d("+t(e[0])+","+t(-e[1])+","+t(e[2])+","+t(e[3])+","+t(e[4])+","+t(-e[5])+","+t(e[6])+","+t(e[7])+","+t(e[8])+","+t(-e[9])+","+t(e[10])+","+t(e[11])+","+t(e[12])+","+t(-e[13])+","+t(e[14])+","+t(e[15])+")"}function y(i){const e=i.elements;return"translate(-50%,-50%)"+("matrix3d("+t(e[0])+","+t(e[1])+","+t(e[2])+","+t(e[3])+","+t(-e[4])+","+t(-e[5])+","+t(-e[6])+","+t(-e[7])+","+t(e[8])+","+t(e[9])+","+t(e[10])+","+t(e[11])+","+t(e[12])+","+t(e[13])+","+t(e[14])+","+t(e[15])+")")}function w(i,e,m,S){if(i.isCSS3DObject){i.onBeforeRender(n,e,m);let p;i.isCSS3DSprite?(f.copy(m.matrixWorldInverse),f.transpose(),i.rotation2D!==0&&f.multiply(_.makeRotationZ(i.rotation2D)),i.matrixWorld.decompose(b,I,C),f.setPosition(b),f.scale(C),f.elements[3]=0,f.elements[7]=0,f.elements[11]=0,f.elements[15]=1,p=y(f)):p=y(i.matrixWorld);const g=i.element,x=l.objects.get(i);if(x===void 0||x.style!==p){g.style.transform=p;const D={style:p};l.objects.set(i,D)}g.style.display=i.visible?"":"none",g.parentNode!==a&&a.appendChild(g),i.onAfterRender(n,e,m)}for(let p=0,g=i.children.length;p<g;p++)w(i.children[p],e,m)}}}const R=new c.Matrix4;R.compose(new c.Vector3,new c.Quaternion,new c.Vector3(.001,.001,.001));class T{constructor({container:o,imageTargetSrc:n,maxTrack:h,uiLoading:r="yes",uiScanning:d="yes",uiError:u="yes",filterMinCF:l=null,filterBeta:s=null,warmupTolerance:a=null,missTolerance:t=null}){this.container=o,this.imageTargetSrc=n,this.maxTrack=h,this.filterMinCF=l,this.filterBeta=s,this.warmupTolerance=a,this.missTolerance=t,this.ui=new W.UI({uiLoading:r,uiScanning:d,uiError:u}),this.scene=new c.Scene,this.cssScene=new c.Scene,this.renderer=new c.WebGLRenderer({antialias:!0,alpha:!0}),this.cssRenderer=new O({antialias:!0}),this.renderer.outputEncoding=c.sRGBEncoding,this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new c.PerspectiveCamera,this.anchors=[],this.renderer.domElement.style.position="absolute",this.cssRenderer.domElement.style.position="absolute",this.container.appendChild(this.renderer.domElement),this.container.appendChild(this.cssRenderer.domElement),window.addEventListener("resize",this.resize.bind(this))}async start(){this.ui.showLoading(),await this._startVideo(),await this._startAR()}stop(){this.controller.stopProcessVideo(),this.video.srcObject.getTracks().forEach(function(n){n.stop()}),this.video.remove()}addAnchor(o){const n=new c.Group;n.visible=!1,n.matrixAutoUpdate=!1;const h={group:n,targetIndex:o,onTargetFound:null,onTargetLost:null,css:!1,visible:!1};return this.anchors.push(h),this.scene.add(n),h}addCSSAnchor(o){const n=new c.Group;n.visible=!1,n.matrixAutoUpdate=!1;const h={group:n,targetIndex:o,onTargetFound:null,onTargetLost:null,css:!0,visible:!1};return this.anchors.push(h),this.cssScene.add(n),h}_startVideo(){return new Promise((o,n)=>{if(this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="-2",this.container.appendChild(this.video),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this.ui.showCompatibility(),n();return}navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}).then(h=>{this.video.addEventListener("loadedmetadata",()=>{this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight),o()}),this.video.srcObject=h}).catch(h=>{console.log("getUserMedia error",h),n()})})}_startAR(){return new Promise(async(o,n)=>{const h=this.video;this.container,this.controller=new E.Controller({inputWidth:h.videoWidth,inputHeight:h.videoHeight,filterMinCF:this.filterMinCF,filterBeta:this.filterBeta,warmupTolerance:this.warmupTolerance,missTolerance:this.missTolerance,maxTrack:this.maxTrack,onUpdate:d=>{if(d.type==="updateMatrix"){const{targetIndex:u,worldMatrix:l}=d;for(let s=0;s<this.anchors.length;s++)if(this.anchors[s].targetIndex===u){if(this.anchors[s].css?this.anchors[s].group.children.forEach(a=>{a.element.style.visibility=l===null?"hidden":"visible"}):this.anchors[s].group.visible=l!==null,l!==null){let a=new c.Matrix4;a.elements=[...l],a.multiply(this.postMatrixs[u]),this.anchors[s].css&&a.multiply(R),this.anchors[s].group.matrix=a}this.anchors[s].visible&&l===null&&(this.anchors[s].visible=!1,this.anchors[s].onTargetLost&&this.anchors[s].onTargetLost()),!this.anchors[s].visible&&l!==null&&(this.anchors[s].visible=!0,this.anchors[s].onTargetFound&&this.anchors[s].onTargetFound()),l!==null&&this.ui.hideScanning()}}}}),this.resize();const{dimensions:r}=await this.controller.addImageTargets(this.imageTargetSrc);this.postMatrixs=[];for(let d=0;d<r.length;d++){const u=new c.Vector3,l=new c.Quaternion,s=new c.Vector3,[a,t]=r[d];u.x=a/2,u.y=a/2+(t-a)/2,s.x=a,s.y=a,s.z=a;const v=new c.Matrix4;v.compose(u,l,s),this.postMatrixs.push(v)}await this.controller.dummyRun(this.video),this.ui.hideLoading(),this.ui.showScanning(),this.controller.processVideo(this.video),o()})}resize(){const{renderer:o,cssRenderer:n,camera:h,container:r,video:d}=this;if(!d)return;let u,l;const s=d.videoWidth/d.videoHeight,a=r.clientWidth/r.clientHeight;s>a?(l=r.clientHeight,u=l*s):(u=r.clientWidth,l=u/s);const t=this.controller.getProjectionMatrix(),v=2*Math.atan(1/t[5]/l*r.clientHeight)*180/Math.PI,y=t[14]/(t[10]-1),w=t[14]/(t[10]+1);t[5]/t[0],h.fov=v,h.near=y,h.far=w,h.aspect=r.clientWidth/r.clientHeight,h.updateProjectionMatrix(),d.style.top=-(l-r.clientHeight)/2+"px",d.style.left=-(u-r.clientWidth)/2+"px",d.style.width=u+"px",d.style.height=l+"px";const i=o.domElement,e=n.domElement;i.style.position="absolute",i.style.left=0,i.style.top=0,i.style.width=r.clientWidth+"px",i.style.height=r.clientHeight+"px",e.style.position="absolute",e.style.left=0,e.style.top=0,e.style.width=r.clientWidth+"px",e.style.height=r.clientHeight+"px",o.setSize(r.clientWidth,r.clientHeight),n.setSize(r.clientWidth,r.clientHeight)}}window.MINDAR||(window.MINDAR={});window.MINDAR.IMAGE||(window.MINDAR.IMAGE={});window.MINDAR.IMAGE.MindARThree=T;window.MINDAR.IMAGE.tf=E.tf;exports.MindARThree=T;
